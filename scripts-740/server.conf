#! /bin/bash

# (C) 2016 Maximilian Wende <maximilian.wende@gmail.com>
#
# This file is licensed under the Apache License 2.0. For more information,
# see the LICENSE file or visit: http://www.apache.org/licenses/LICENSE-2.0




###############################################
#                                             #
#  You should DEFINITELY look into this file  #
#  and configure everything the way you need  #
#                                             #
###############################################




# NOTE: the var=${var-"value"} syntax assigns value to var, only if var is not set yet.
####### This way you can set some of these via the command line, and they will not be overridden by this


#
#  SECTION 1: BASIC SERVER DATA
#
###############################

# Game Server Login Token - Insert here
GSLT=${GSLT-""}

# Note that LOCAL_IP and WAN_IP are optional, you should set them though for rented servers
LOCAL_IP=${LOCAL_IP-""}
WAN_IP=${WAN_IP-""}
PORT=${PORT-"27015"}

# IP and Port for this server to be advertised in the server browser
# You should set HOSTIP and HOSTPORT in the case that your game server is behind NAT
HOSTIP=${HOSTIP-"${WAN_IP:-"$LOCAL_IP"}"}
HOSTPORT=${HOSTPORT-"$PORT"}

# Password for clients to connect
PASS=${PASS-"yourpasswordhere"}

# This effectively disables RCON by generating a random password
RCON_PASS=${RCON_PASS-"$(dd status=none if=/dev/urandom bs=24 count=1 | base64)"}

# TICKRATE
TICKRATE=${TICKRATE-"128"}

# SV_PURE - If enabled, clients with non-matching files will be kicked. You may need to disable it when using specific mods
SV_PURE=${SV_PURE-"1"}

# SV_CHEATS - Enables several commands for testing purposes, which would seriously impact gameplay otherwise
SV_CHEATS=${SV_CHEATS-"0"}




#
# SECTION 2: SELECT THE GAMEMODE
#
################################

# Select the gamemode
MODE=${MODE-"competitive"}

# Your tags, as comma-separated list. The mode or addon script(s) could set additional tags
TAGS="$MODE"
# The server title in the server browser
HOSTNAME="CS:GO $MODE server (powered by csgo-multiserver)"

# Execute the gamemode's specific configuration file
. "$INSTANCE_DIR/msm.d/modes/$MODE.conf"




#
# SECTION 3: MULTIPLAYER SETTINGS / MAPS
#
########################################

MAXPLAYERS=${MAXPLAYERS-"10"}

#
# TODO: allow entering workshop IDs and automatically generate the respective arguments
#

# Mapgroup - if you use a vanilla server
MAPGROUP=${MAPGROUP-"mg_active"}

# Maps - set the mapcycle, typically used by sourcemod and its plugins
MAPS=${MAPS-"de_dust2 de_train de_mirage de_cache de_cbble de_overpass de_nuke"}

# convert to array, if necessary
MAPS=( ${MAPS[*]} )

# Map - the map to load when the server starts up. Use the first element of the maps array by default
MAP=${MAP-"${MAPS[0]}"}


# Note that MANY gameplay-related settings have to be made in your gamemode_<xyz>_server.cfg instead of here



#
#  SECTION 4: GOTV
#
##################

# If this is set to 1, people can watch the game via game UI. They will NOT need to type the password
TV_ADVERTIZE_WATCHABLE=${TV_ADVERTIZE_WATCHABLE-"0"}


TV_PORT=${TV_PORT-"27020"}
TV_PASS=${TV_PASS-"yourtvpasswordhere"}
TV_DELAY=${TV_DELAY-"60"}

# The default GOTV Tickrate is 16 ...
#
# Keep in mind that a higher Snapshotrate increases your demo file size
# and might stress your server / cause lag
TV_SNAPSHOTRATE=${TV_SNAPSHOTRATE-"$(( TICKRATE / 2 ))"}

# Some slots, so your cameraman & caster and some GOTV Relays can connect
# Note that, according to the sparse documentation, the server should automatically redirect clients to the relay servers
TV_MAXCLIENTS=${TV_MAXCLIENTS-"4"}

TV_TITLE=${TV_TITLE-"[GOTV] $HOSTNAME"}

# GOTV_RELAY

# By using relay proxies, many spectators can watch your game without reducing the performance of your game server
# If this server instance should be a GOTV Relay Proxy, specify the host here. Format: "11.22.33.44:27020"
TV_RELAY=${TV_RELAY-""}
TV_RELAYPASS=${TV_RELAYPASS-"yourrelaytvpasswordhere"}

# Game casting options

# If set, the user with the given SteamID (64 Bit) will control the camera for the remaining watchers.
# The cameraman will HAVE TO start the game with the -interactivecaster command line option.
# Command: tv_allow_cameraman
TV_CAMERAMAN=${TV_CAMERAMAN-""}

# The commentator's SteamID whose voice will be transmitted to the remaining watchers
# Command: voice_caster_enable
TV_VOICE_CASTER=${TV_VOICE_CASTER-""}

#
# TODO: find out how to display sponsor icons / etc.
#




######################## GENERATE CONFIG FILES #########################

cfg-disclaimer () { cat <<-EOF; }
	// This file was generated by csgo-multiserver, licensed under the Apache License 2.0
	// See https://github.com/dasisdormax/csgo-multiserver for more information
	EOF


MAPCYCLE_TXT="$INSTANCE_DIR/csgo/mapcycle.txt"
rm "$MAPCYCLE_TXT"
for map in ${MAPS[@]}; do
	echo "$map" >> "$MAPCYCLE_TXT"
	done


# This is executed once upon starting the server
AUTOEXEC_CFG="$INSTANCE_DIR/csgo/cfg/autoexec.cfg"
cfg-disclaimer > "$AUTOEXEC_CFG"
tee -a "$AUTOEXEC_CFG" > /dev/null <<-EOF



	// -------- BASIC STUFF --------

	log on
	sv_password "$PASS"
	rcon_password "$RCON_PASS"

	hostname "$HOSTNAME"
	hostip "$HOSTIP"
	hostport "$HOSTPORT"

	sv_tags "$TAGS"

	// sv_lan should NEVER be set, because it disables VAC protection and prevents loading of a player's inventory
	sv_lan 0

	sv_pure "$SV_PURE"
	sv_cheats "$SV_CHEATS"

	exec banned_user.cfg // Read list of banned users



	// --------- GOTV ----------

	EOF


SERVER_CFG="$INSTANCE_DIR/csgo/cfg/server.cfg"
cfg-disclaimer > "$SERVER_CFG"
tee -a "$SERVER_CFG" > /dev/null <<-EOF



	writeid // Update banned_user.cfg
	EOF

# This file is very much incomplete
